
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../stable_diffusion_3_reading/">
      
      
        <link rel="next" href="../flux1/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Stable Diffusion 3.5 - Generative AI: From Start to Surrender</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stable-diffusion-35" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Generative AI: From Start to Surrender" class="md-header__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Generative AI: From Start to Surrender
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Stable Diffusion 3.5
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter1_Introduction/1.1terminology/" class="md-tabs__link">
          
  
    
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter2_generation_theory/mle/" class="md-tabs__link">
          
  
    
  
  Generation Theory

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter3_energy_based_model/introduction/" class="md-tabs__link">
          
  
    
  
  Energy Based Models

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter6_VAE/vae_introduction/" class="md-tabs__link">
          
  
    
  
  VAE

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-tabs__link">
          
  
    
  
  GANs

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter7_diffusion/ddpm/" class="md-tabs__link">
          
  
    
  
  Diffusion Models

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter9_flow_matching/introduction/" class="md-tabs__link">
          
  
    
  
  Flow Matching

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../hybrid_methods/" class="md-tabs__link">
          
  
    
  
  Hybrid SOTA Models

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../chapter12_applications/diffusion_anomaly_detection/" class="md-tabs__link">
          
  
    
  
  Application

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Generative AI: From Start to Surrender" class="md-nav__button md-logo" aria-label="Generative AI: From Start to Surrender" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Generative AI: From Start to Surrender
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.1terminology/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.2fourier_transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fourier Transform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.3signal_processing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Signal Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/1.4statistics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Statistics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter1_Introduction/tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Generation Theory
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Generation Theory
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/mle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maximal Likelihood
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/manifold_hypothesis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manifold Hypothesis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter2_generation_theory/generative_model_category/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generative Model Category
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Energy Based Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Energy Based Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/score_function/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Score Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/sampling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sampling Methods
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/cd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contrastive Divergence
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter3_energy_based_model/score_matching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Score Matching
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    VAE
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            VAE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter6_VAE/vae_introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter6_VAE/vq_vae/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VA-VAE
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    GANs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            GANs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.1from_gan_to_stylegan/paper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    From GAN to StyleGAN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    StyleGAN Variants
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            StyleGAN Variants
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.3stylegan/paper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StyleGAN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.4stylegan2/paper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StyleGAN2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.5stylegan3/paper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StyleGAN3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.6styleganT/paper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    StyleGAN-T
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/3.7R3Gan/paper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    R3GAN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter5_GAN/vq_gan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VQ-GAN
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Diffusion Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Diffusion Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Discrete Diffusion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Discrete Diffusion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ddpm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ldm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/ldm_handson/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDM Handson
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/diffusion_model_varients/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Diffusion Model Varients
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/general_diffusion_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    General Diffusion Model
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SDE Diffusion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            SDE Diffusion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/introduction_sde/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDE Fundamentals
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/from_ddpm_2_sde/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDE for DDPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/score_based_sde/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Score Based SDE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/probability_flow_ode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Probability Flow ODE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_speedup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDE Diffusion Speedup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_unified_representation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scaling and Scheduling
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Diffusion Network
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Diffusion Network
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/DiT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DiT
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Diffusion Solver
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            Diffusion Solver
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/diffusion_solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DPM Solver
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Conditional Diffusion
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            Conditional Diffusion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/controlnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ControlNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter7_diffusion/sde_diffusion_guidance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDE Diffusion Guidance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Flow Matching
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Flow Matching
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/probability_with_velocity_field/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Probability Path and Velocity Fields
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/flow_matching_theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flow Matching Theorem
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/affine_conditional_flows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Affine Conditional Flow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/optimal_transport_flow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimal Transport Flow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter9_flow_matching/comparison_with_flow_ode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Comparison with Diffusion Flow ODE
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Hybrid SOTA Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Hybrid SOTA Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hybrid_methods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hybrid Methods
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sota_closed_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Closed Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3" id="__nav_9_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Open Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3">
            <span class="md-nav__icon md-icon"></span>
            Open Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dalle_series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dalle Series
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_9_3_2" id="__nav_9_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Stable Diffusion Series
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_3_2">
            <span class="md-nav__icon md-icon"></span>
            Stable Diffusion Series
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_xl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stable Diffusion XL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stable_diffusion_3_reading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stable Diffusion 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Stable Diffusion 3.5
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Stable Diffusion 3.5
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-summary-of-key-architectural-differences" class="md-nav__link">
    <span class="md-ellipsis">
      1. Summary of Key Architectural Differences
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-skip-layer-guidance" class="md-nav__link">
    <span class="md-ellipsis">
      2. Skip Layer Guidance
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-mm-ditx" class="md-nav__link">
    <span class="md-ellipsis">
      3. MM-DiTX
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. MM-DiTX">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-architecture-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Architecture Enhancements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-2-module-improvements" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 2. Module Improvements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-3-code-quality-and-maintainability" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 3. Code Quality and Maintainability
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-4-performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 4. Performance Optimization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-summary" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-controlnet-in-sd-35" class="md-nav__link">
    <span class="md-ellipsis">
      4. ControlNet in SD 3.5
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. ControlNet in SD 3.5">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-cnotrolnet-condition-process" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 CnotrolNet Condition Process
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flux1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flux.1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../trends_future/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Future Trends
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Application
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Application
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_1" >
        
          
          <label class="md-nav__link" for="__nav_10_1" id="__nav_10_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Anomaly Detection
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_1">
            <span class="md-nav__icon md-icon"></span>
            Anomaly Detection
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/diffusion_anomaly_detection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Diffusion Anomaly Detection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../chapter12_applications/deepfake_detection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deepfake Detection
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="stable-diffusion-35">Stable Diffusion 3.5<a class="headerlink" href="#stable-diffusion-35" title="Permanent link">&para;</a></h1>
<ul>
<li>repo: <a href="https://github.com/Stability-AI/sd3.5">https://github.com/Stability-AI/sd3.5</a></li>
</ul>
<h2 id="1-summary-of-key-architectural-differences">1. Summary of Key Architectural Differences<a class="headerlink" href="#1-summary-of-key-architectural-differences" title="Permanent link">&para;</a></h2>
<ol>
<li>Architecture Enhancements</li>
<li>Skip Layer Guidance (SLG):
         - SD3.5 introduces this novel technique that selectively skips specific transformer layers (typically 7-9)
         - Only active during 1-20% of the sampling process
         - Uses a separate guidance scale (2.5 in SD3.5 Medium) distinct from the main CFG scale
         - Significantly improves image coherence and reduces artifacts</li>
<li>MMDiTX vs MMDiT:
        - SD3.5 uses the enhanced MMDiTX architecture with more flexible configuration options
        - Added support for cross-block attention with x_block_self_attn
        - Improved normalization with RMSNorm support as an alternative to LayerNorm
        - Better parameter management and more modular design</li>
<li>Sampling Improvements</li>
<li>Default Samplers:
         - SD3: Uses euler sampler as default
         - SD3.5: Uses dpmpp_2m (DPM-Solver++) sampler for better quality</li>
<li>Noise Scheduling:
         - SD3: Uses shift=1.0
         - SD3.5: Uses shift=3.0 for improved noise distribution</li>
<li>Default Configurations:
         - SD3.5 Medium: 50 steps, CFG 5.0, with Skip Layer Guidance
         - SD3.5 Large: 40 steps, CFG 4.5
         - SD3.5 Large Turbo: 4 steps, CFG 1.0 (optimized for speed)</li>
<li>
<p>New Capabilities</p>
<ol>
<li>ControlNet Integration:
        - Native support for various ControlNet types (blur, canny, depth)
        - Dedicated ControlNetEmbedder class for processing control inputs
        - Support for 8-bit and 2-bit ControlNet variations</li>
<li>Attention Mechanisms:
        - More configurable attention with qk_norm options
        - Enhanced cross-attention capabilities
        - Better handling of long-range dependencies</li>
</ol>
</li>
<li>
<p>Technical Implementation</p>
</li>
<li>
<p>Code Quality:</p>
<ul>
<li>More modular design in SD3.5</li>
<li>Better type hinting and parameter validation</li>
<li>Enhanced error handling and debugging capabilities</li>
</ul>
</li>
<li>Performance:<ul>
<li>More efficient attention mechanisms</li>
<li>Better memory management</li>
<li>Support for different precision modes</li>
</ul>
</li>
</ol>
<p>In this article, we will study the differences in architecture, such as skip layer guidance and MM-DiTX. We will also explore how ControlNet is implemented in SD3.5.</p>
<p>As for the elements that are similar to SD 3, including the VAE, prompt processing, and sampling scheme, the differences are not significant. Please refer to the previous article <a href="../stable_diffusion_3_reading/">stable diffusion 3 reading</a> for more information.</p>
<h2 id="2-skip-layer-guidance">2. Skip Layer Guidance<a class="headerlink" href="#2-skip-layer-guidance" title="Permanent link">&para;</a></h2>
<p>Let's first look at the CFG in SD3</p>
<p><a class="glightbox" href="../../../../images/image-101.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-101.png" /></a></p>
<p>Now let's look as the SLG in SD 3.5</p>
<table>
<thead>
<tr>
<th><a class="glightbox" href="../../../../images/image-95.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-95.png" /></a></th>
<th><a class="glightbox" href="../../../../images/image-96.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-96.png" /></a></th>
</tr>
</thead>
<tbody>
<tr>
<td>w/o SLG</td>
<td>w/ SLG</td>
</tr>
</tbody>
</table>
<p>Apparently, the fingers look better. This could be evidence that supports the claimed benefits (improved anatomy). However, other aspects of the image also change.</p>
<table>
<thead>
<tr>
<th><a class="glightbox" href="../../../../images/image-98.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-98.png" /></a></th>
<th><a class="glightbox" href="../../../../images/image-97.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-97.png" /></a></th>
<th><a class="glightbox" href="../../../../images/image-99.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-99.png" /></a></th>
</tr>
</thead>
<tbody>
<tr>
<td>vanilla diffusers which looks awful</td>
<td>skipping layers 6, 7, 8, 9 with SLG scale of 5.6</td>
<td>skipping 7, 8, 9 with SLG scale of 2.8</td>
</tr>
</tbody>
</table>
<p>See more comparisons of CFG and SLG in <a href="https://sandner.art/sd-35-medium-skip-layer-guidance-and-fix-composition-hands-and-anatomy/">here</a></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
# From SkipLayerCFGDenoiser in SD3.5
def forward(self, x, timestep, cond, uncond, cond_scale, **kwargs):
    # Run cond and uncond in a batch together
    batched = self.model.apply_model(
        torch.cat([x, x]),
        torch.cat([timestep, timestep]),
        c_crossattn=torch.cat([cond[&quot;c_crossattn&quot;], uncond[&quot;c_crossattn&quot;]]),
        y=torch.cat([cond[&quot;y&quot;], uncond[&quot;y&quot;]]),
        **kwargs,
    )
    # Then split and apply CFG Scaling
    pos_out, neg_out = batched.chunk(2)
    scaled = neg_out + (pos_out - neg_out) * cond_scale

    # Then run with skip layer
    if (self.slg &gt; 0 and self.step &gt; (self.skip_start * self.steps)
        and self.step &lt; (self.skip_end * self.steps)):
        skip_layer_out = self.model.apply_model(
            x, timestep, c_crossattn=cond[&quot;c_crossattn&quot;],
            y=cond[&quot;y&quot;], skip_layers=self.skip_layers,
        )
        # Then scale acc to skip layer guidance
        scaled = scaled + (pos_out - skip_layer_out) * self.slg

    self.step += 1
    return scaled
```
</code></pre></div></td></tr></table></div>
<p>Compared to CFG, SLG incorporates an additional direction correction term, which helps improve anatomical accuracy in generated images.</p>
<p>According to the configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code>```json
&quot;sd3.5_medium&quot;: {
    &quot;shift&quot;: 3.0,
    &quot;steps&quot;: 50,
    &quot;cfg&quot;: 5.0,
    &quot;sampler&quot;: &quot;dpmpp_2m&quot;,
    &quot;skip_layer_config&quot;: {
        &quot;scale&quot;: 2.5,
        &quot;start&quot;: 0.01,  # skip_start value
        &quot;end&quot;: 0.20,    # skip_end value
        &quot;layers&quot;: [7, 8, 9],
        &quot;cfg&quot;: 4.0,
    },
}
```
</code></pre></div></td></tr></table></div>
<p>The skip layer guidance is only active during the initial 1-20% of the sampling process, targeting layers [7, 8, 9], and scaling the CFG to 4.0.</p>
<p>In the MM-DiTX implementation, the skip layers are treated as identity functions:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
for i, block in enumerate(self.joint_blocks):
    if i in skip_layers:
        continue
    context, x = block(context, x, c=c_mod)
```
</code></pre></div></td></tr></table></div>
<p>Both <code>pos_out</code> and <code>skip_layer_out</code> use the same positive condition but differ in their treatment of skip layers. If we consider the skipped layers as a negative condition, this effectively pushes the sample away from that negative influence. What does this negative influence represent when removing layers 7, 8, and 9 (or any specific layers)? If we assume that specific layers are responsible for different features in the image—for example, if layers 7, 8, and 9 handle finer details—then the negative condition would produce images with poor fine structure. Therefore, moving away from this negative influence results in images with enhanced fine details and better structural integrity.</p>
<h2 id="3-mm-ditx">3. MM-DiTX<a class="headerlink" href="#3-mm-ditx" title="Permanent link">&para;</a></h2>
<p>By comparing the implementations of SD3's MMDiT and SD3.5's MMDiTX, I found the following key differences:</p>
<h3 id="31-architecture-enhancements">3.1 Architecture Enhancements<a class="headerlink" href="#31-architecture-enhancements" title="Permanent link">&para;</a></h3>
<h4 id="311-cross-block-self-attention">3.1.1 Cross-Block Self-Attention<a class="headerlink" href="#311-cross-block-self-attention" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>New in MMDiTX:</strong> The addition of the <code>x_block_self_attn</code> feature.</li>
<li><strong>Implementation:</strong> A second self-attention module, <code>self.attn2</code>, has been added within the <code>DismantledBlock</code>.</li>
<li><strong>Control:</strong> This feature is enabled on specific layers using the <code>x_block_self_attn_layers</code> parameter.</li>
<li><strong>Purpose:</strong> It allows specific layers to perform two different self-attention operations simultaneously, enhancing the model's expressive capability.</li>
</ul>
<p>Structure of MM-DiT</p>
<p><a class="glightbox" href="../../../../images/network_sd3.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/network_sd3.png" /></a></p>
<p>The DismantleBlock added new methods</p>
<h5 id="3111-pre-attention">3.1.1.1 Pre-Attention<a class="headerlink" href="#3111-pre-attention" title="Permanent link">&para;</a></h5>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">pre_attention_x</label><label for="__tabbed_1_2">pre_attention</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span>
<span class="normal"><a href="#__codelineno-3-27">27</a></span>
<span class="normal"><a href="#__codelineno-3-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>    <span class="k">def</span> <span class="nf">pre_attention_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_block_self_attn</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>        <span class="p">(</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>            <span class="n">shift_msa</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>            <span class="n">scale_msa</span><span class="p">,</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>            <span class="n">gate_msa</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>            <span class="n">shift_mlp</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>            <span class="n">scale_mlp</span><span class="p">,</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>            <span class="n">gate_mlp</span><span class="p">,</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>            <span class="n">shift_msa2</span><span class="p">,</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>            <span class="n">scale_msa2</span><span class="p">,</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>            <span class="n">gate_msa2</span><span class="p">,</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>        <span class="n">x_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>        <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="n">qkv2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn2</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="n">x_norm</span><span class="p">,</span> <span class="n">shift_msa2</span><span class="p">,</span> <span class="n">scale_msa2</span><span class="p">))</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>        <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>            <span class="n">qkv</span><span class="p">,</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>            <span class="n">qkv2</span><span class="p">,</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a>            <span class="p">(</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a>                <span class="n">x</span><span class="p">,</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a>                <span class="n">gate_msa</span><span class="p">,</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a>                <span class="n">shift_mlp</span><span class="p">,</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>                <span class="n">scale_mlp</span><span class="p">,</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>                <span class="n">gate_mlp</span><span class="p">,</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a>                <span class="n">gate_msa2</span><span class="p">,</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a>            <span class="p">),</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span> <span class="nf">pre_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">assert</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;pre_attention called with None input&quot;</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>            <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>            <span class="n">shift_msa</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="n">shift_mlp</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>            <span class="n">scale_msa</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>        <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>        <span class="k">return</span> <span class="n">qkv</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span><span class="p">)</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_mod_only</span><span class="p">:</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>            <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>            <span class="n">shift_msa</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>            <span class="n">scale_msa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaLN_modulation</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>        <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_msa</span><span class="p">,</span> <span class="n">scale_msa</span><span class="p">))</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>        <span class="k">return</span> <span class="n">qkv</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
<p>compared with the <code>pre_attention</code>, the <code>pre_attention_x</code> process <code>x</code> twice.</p>
</div>
</div>
</div>
<h5 id="3112-post-attention">3.1.1.2 Post Attention<a class="headerlink" href="#3112-post-attention" title="Permanent link">&para;</a></h5>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">SD3</label><label for="__tabbed_2_2">post_attention</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">def</span> <span class="nf">post_attention_x</span><span class="p">(</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="n">attn</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="n">attn2</span><span class="p">,</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="n">x</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="n">gate_msa</span><span class="p">,</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>    <span class="n">shift_mlp</span><span class="p">,</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>    <span class="n">scale_mlp</span><span class="p">,</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="n">gate_mlp</span><span class="p">,</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="n">gate_msa2</span><span class="p">,</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>    <span class="n">attn1_dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="p">):</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>    <span class="k">if</span> <span class="n">attn1_dropout</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="c1"># Use torch.bernoulli to implement dropout, only dropout the batch dimension</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="n">attn1_dropout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">attn</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">attn1_dropout</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">attn</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="p">)</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>        <span class="n">attn_</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>            <span class="n">gate_msa</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span> <span class="o">*</span> <span class="n">attn1_dropout</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>        <span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>        <span class="n">attn_</span> <span class="o">=</span> <span class="n">gate_msa</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">attn_</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a>    <span class="n">attn2_</span> <span class="o">=</span> <span class="n">gate_msa2</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn2</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn2</span><span class="p">)</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">attn2_</span>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a>    <span class="n">mlp_</span> <span class="o">=</span> <span class="n">gate_mlp</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a>        <span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">)</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a>    <span class="p">)</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">mlp_</span>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a>    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">def</span> <span class="nf">post_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">gate_msa</span><span class="p">,</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">,</span> <span class="n">gate_mlp</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_only</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">gate_msa</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">gate_mlp</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">modulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">shift_mlp</span><span class="p">,</span> <span class="n">scale_mlp</span><span class="p">))</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>Compared with <code>post_attention</code>, the <code>post_attention</code> accepts two attentions <code>attn</code> and <code>attn2</code>.</p>
<h5 id="3113-block_mixing">3.1.1.3 block_mixing<a class="headerlink" href="#3113-block_mixing" title="Permanent link">&para;</a></h5>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">sd3.5</label><label for="__tabbed_3_2">sd3</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">def</span> <span class="nf">block_mixing</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">context_block</span><span class="p">,</span> <span class="n">x_block</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;block_mixing called with None context&quot;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="n">context_qkv</span><span class="p">,</span> <span class="n">context_intermediates</span> <span class="o">=</span> <span class="n">context_block</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="k">if</span> <span class="n">x_block</span><span class="o">.</span><span class="n">x_block_self_attn</span><span class="p">:</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="n">x_qkv</span><span class="p">,</span> <span class="n">x_qkv2</span><span class="p">,</span> <span class="n">x_intermediates</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">pre_attention_x</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>        <span class="n">x_qkv</span><span class="p">,</span> <span class="n">x_intermediates</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">qkv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">qkv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">context_qkv</span><span class="p">,</span> <span class="n">x_qkv</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>    <span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x_block</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>    <span class="n">context_attn</span><span class="p">,</span> <span class="n">x_attn</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="n">attn</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">context_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="n">attn</span><span class="p">[:,</span> <span class="n">context_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:],</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>    <span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">context_block</span><span class="o">.</span><span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">context_block</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">context_attn</span><span class="p">,</span> <span class="o">*</span><span class="n">context_intermediates</span><span class="p">)</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>        <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>    <span class="k">if</span> <span class="n">x_block</span><span class="o">.</span><span class="n">x_block_self_attn</span><span class="p">:</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>        <span class="n">x_q2</span><span class="p">,</span> <span class="n">x_k2</span><span class="p">,</span> <span class="n">x_v2</span> <span class="o">=</span> <span class="n">x_qkv2</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>        <span class="n">attn2</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">x_q2</span><span class="p">,</span> <span class="n">x_k2</span><span class="p">,</span> <span class="n">x_v2</span><span class="p">,</span> <span class="n">x_block</span><span class="o">.</span><span class="n">attn2</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">post_attention_x</span><span class="p">(</span><span class="n">x_attn</span><span class="p">,</span> <span class="n">attn2</span><span class="p">,</span> <span class="o">*</span><span class="n">x_intermediates</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">x_attn</span><span class="p">,</span> <span class="o">*</span><span class="n">x_intermediates</span><span class="p">)</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>    <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span> <span class="nf">block_mixing</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">context_block</span><span class="p">,</span> <span class="n">x_block</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;block_mixing called with None context&quot;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="n">context_qkv</span><span class="p">,</span> <span class="n">context_intermediates</span> <span class="o">=</span> <span class="n">context_block</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>    <span class="n">x_qkv</span><span class="p">,</span> <span class="n">x_intermediates</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">pre_attention</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>    <span class="n">o</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>        <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">context_qkv</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">x_qkv</span><span class="p">[</span><span class="n">t</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>    <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x_block</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">num_heads</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>    <span class="n">context_attn</span><span class="p">,</span> <span class="n">x_attn</span> <span class="o">=</span> <span class="p">(</span><span class="n">attn</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">context_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">attn</span><span class="p">[:,</span> <span class="n">context_qkv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:])</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">context_block</span><span class="o">.</span><span class="n">pre_only</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">context_block</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">context_attn</span><span class="p">,</span> <span class="o">*</span><span class="n">context_intermediates</span><span class="p">)</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x_block</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">x_attn</span><span class="p">,</span> <span class="o">*</span><span class="n">x_intermediates</span><span class="p">)</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>    <span class="k">return</span> <span class="n">context</span><span class="p">,</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>if 'x_block_self_attn' is False in the <code>blocking_mixing</code>, then it is same as old version. If it true, then</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
def block_mixing(context, x, context_block, x_block, c):
    assert context is not None, &quot;block_mixing called with None context&quot;
    context_qkv, context_intermediates = context_block.pre_attention(context, c)
    x_qkv, x_qkv2, x_intermediates = x_block.pre_attention_x(x, c)
    q, k, v = tuple(
        torch.cat(tuple(qkv[i] for qkv in [context_qkv, x_qkv]), dim=1)
        for i in range(3)
    )
    attn = attention(q, k, v, x_block.attn.num_heads)
    context_attn, x_attn = (
        attn[:, : context_qkv[0].shape[1]],
        attn[:, context_qkv[0].shape[1] :],
    )
    if not context_block.pre_only:
        context = context_block.post_attention(context_attn, *context_intermediates)
    else:
        context = None
    x_q2, x_k2, x_v2 = x_qkv2
    attn2 = attention(x_q2, x_k2, x_v2, x_block.attn2.num_heads)
    x = x_block.post_attention_x(x_attn, attn2, *x_intermediates)
    return context, x
```
</code></pre></div></td></tr></table></div>
<p>This added another attention for the copy of <span class="arithmatex">\(x\)</span>, the main purpise is to increase the capability for latent path, which in sd3, the path for 'context' and 'latent' is symmetric.</p>
<p><a class="glightbox" href="../../../../images/image-100.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="alt text" src="../../../../images/image-100.png" /></a></p>
<h4 id="312-more-flexible-attention-mechanism">3.1.2 More Flexible Attention Mechanism<a class="headerlink" href="#312-more-flexible-attention-mechanism" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Removed in MMDiTX:</strong> The <code>attn_mode</code> parameter (which in MMDiT supported modes like "xformers", "torch", "torch-hb", "math", "debug").</li>
<li><strong>Simplification:</strong> The attention implementation is now more unified, eliminating the need to switch between different modes.</li>
</ul>
<h4 id="313-support-for-controlnet">3.1.3 Support for ControlNet<a class="headerlink" href="#313-support-for-controlnet" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>New in MMDiTX:</strong> The <code>controlnet_hidden_states</code> parameter has been added to the <code>forward</code> method.</li>
<li><strong>Implementation:</strong> ControlNet feature injection logic has been integrated within the Transformer block.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">SD3</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">def</span> <span class="nf">forward_core_with_concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">c_mod</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">&quot;1 ... -&gt; b ...&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">context</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="c1"># context is B, L&#39;, D</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>    <span class="c1"># x is B, L, D</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_blocks</span><span class="p">:</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="n">context</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_mod</span><span class="p">)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c_mod</span><span class="p">)</span>  <span class="c1"># (N, T, patch_size ** 2 * out_channels)</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="admonition note">
<p class="admonition-title">SD3.5</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">def</span> <span class="nf">forward_core_with_concat</span><span class="p">(</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>    <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>    <span class="n">c_mod</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>    <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>    <span class="n">skip_layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="n">controlnet_hidden_states</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>            <span class="p">(</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>                <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">&quot;1 ... -&gt; b ...&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>                <span class="n">context</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([])</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>            <span class="p">),</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>            <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="p">)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>    <span class="c1"># context is B, L&#39;, D</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>    <span class="c1"># x is B, L, D</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_blocks</span><span class="p">):</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skip_layers</span><span class="p">:</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>            <span class="k">continue</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="n">context</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_mod</span><span class="p">)</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>        <span class="k">if</span> <span class="n">controlnet_hidden_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>            <span class="n">controlnet_block_interval</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_blocks</span><span class="p">)</span> <span class="o">//</span> <span class="nb">len</span><span class="p">(</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>                <span class="n">controlnet_hidden_states</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>            <span class="p">)</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">controlnet_hidden_states</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="n">controlnet_block_interval</span><span class="p">]</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c_mod</span><span class="p">)</span>  <span class="c1"># (N, T, patch_size ** 2 * out_channels)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
</div>
<p>The difference is that in sd3.5, there is a <code>controlnet_hidden_states</code> input. At every block, add the controlnet hidden states to the input after MM-DiT block. See more details on the controlnet study in <a href="../../../chapter7_diffusion/controlnet/">control-net</a>. It is equivalent to add an increment in each block. And since the control-net is decoupled, we can train the diffusion first, and then train the controlnet with diffusion model being freezed to simplify the training process.</p>
<h3 id="32-2-module-improvements">3.2 2. Module Improvements<a class="headerlink" href="#32-2-module-improvements" title="Permanent link">&para;</a></h3>
<h4 id="321-21-enhanced-dismantledblock">3.2.1 2.1 Enhanced DismantledBlock<a class="headerlink" href="#321-21-enhanced-dismantledblock" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>New in MMDiTX:</strong> Support for <code>x_block_self_attn</code> mode.</li>
<li><strong>New Methods:</strong> <code>pre_attention_x</code> and <code>post_attention_x</code> have been introduced.</li>
<li><strong>New Logic:</strong> When <code>x_block_self_attn</code> is enabled, 9 modulation parameters are used (instead of the standard 6).</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="k">if</span> <span class="n">x_block_self_attn</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">pre_only</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="n">scale_mod_only</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>    <span class="n">n_mods</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># instead of the standard 6</span>
</code></pre></div></td></tr></table></div>
<h4 id="322-22-enhanced-attention-mechanism">3.2.2 2.2 Enhanced Attention Mechanism<a class="headerlink" href="#322-22-enhanced-attention-mechanism" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>New in MMDiTX:</strong> Support for attention dropout has been added.</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="k">def</span> <span class="nf">post_attention_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">attn1_dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span class="k">if</span> <span class="n">attn1_dropout</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>        <span class="n">attn1_dropout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">attn</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">attn1_dropout</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">attn</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>        <span class="n">attn_</span> <span class="o">=</span> <span class="n">gate_msa</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">post_attention</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span> <span class="o">*</span> <span class="n">attn1_dropout</span>
</code></pre></div></td></tr></table></div>
<h4 id="323-23-skip-layer-support">3.2.3 2.3 Skip Layer Support<a class="headerlink" href="#323-23-skip-layer-support" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>New in MMDiTX:</strong> A <code>skip_layers</code> parameter has been added to the <code>forward_core_with_concat</code> method.</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_blocks</span><span class="p">):</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skip_layers</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="k">continue</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>    <span class="n">context</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c_mod</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<hr />
<h3 id="33-3-code-quality-and-maintainability">3.3 3. Code Quality and Maintainability<a class="headerlink" href="#33-3-code-quality-and-maintainability" title="Permanent link">&para;</a></h3>
<h4 id="331-31-better-type-hints">3.3.1 3.1 Better Type Hints<a class="headerlink" href="#331-31-better-type-hints" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Improvement:</strong> More detailed type annotations have been added.</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>  <span class="c1"># MMDiTX adds List</span>
</code></pre></div></td></tr></table></div>
<h4 id="332-32-clearer-code-formatting">3.3.2 3.2 Clearer Code Formatting<a class="headerlink" href="#332-32-clearer-code-formatting" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Improvement:</strong> More consistent code style and indentation.</li>
<li><strong>Improvement:</strong> Enhanced parameter validation and error checking.</li>
</ul>
<h4 id="333-33-more-detailed-documentation">3.3.3 3.3 More Detailed Documentation<a class="headerlink" href="#333-33-more-detailed-documentation" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Improvement:</strong> Docstrings for functions and classes have been made more detailed.</li>
</ul>
<hr />
<h3 id="34-4-performance-optimization">3.4 4. Performance Optimization<a class="headerlink" href="#34-4-performance-optimization" title="Permanent link">&para;</a></h3>
<h4 id="341-41-more-efficient-attention-computation">3.4.1 4.1 More Efficient Attention Computation<a class="headerlink" href="#341-41-more-efficient-attention-computation" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Improvement:</strong> Multiple attention modes have been removed, focusing on the most efficient implementation.</li>
</ul>
<h4 id="342-42-more-flexible-normalization-options">3.4.2 4.2 More Flexible Normalization Options<a class="headerlink" href="#342-42-more-flexible-normalization-options" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Retention:</strong> Like MMDiT, MMDiTX still supports RMSNorm as an alternative to LayerNorm.</li>
</ul>
<hr />
<h3 id="35-summary">3.5 Summary<a class="headerlink" href="#35-summary" title="Permanent link">&para;</a></h3>
<p>The main improvements of MMDiTX over MMDiT are:</p>
<ul>
<li><strong>Enhanced Model Expressiveness:</strong> The addition of the cross-block self-attention mechanism.</li>
<li><strong>Native Support for Advanced Features:</strong> Built-in support for ControlNet and Skip Layer Guidance.</li>
<li><strong>More Flexible Attention Mechanism:</strong> A unified attention mechanism with additional modulation parameters.</li>
<li><strong>Improved Code Quality:</strong> Enhanced type hints, consistent formatting, better validation, and more detailed documentation.</li>
<li><strong>Performance Optimizations:</strong> More efficient attention computation and flexible normalization options.</li>
</ul>
<h2 id="4-controlnet-in-sd-35">4. ControlNet in SD 3.5<a class="headerlink" href="#4-controlnet-in-sd-35" title="Permanent link">&para;</a></h2>
<h3 id="41-cnotrolnet-condition-process">4.1 CnotrolNet Condition Process<a class="headerlink" href="#41-cnotrolnet-condition-process" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code>```py3
            controlnet_cond = self._image_to_latent(
                controlnet_cond_image, width, height, using_2b, control_type
            )
...
...
def _image_to_latent(
    self,
    image,
    width,
    height,
    using_2b_controlnet: bool = False,
    controlnet_type: int = 0,
) -&gt; torch.Tensor:
    image_data = Image.open(image)
    image_data = image_data.resize((width, height), Image.LANCZOS)
    latent = self.vae_encode(image_data, using_2b_controlnet, controlnet_type)
    latent = SD3LatentFormat().process_in(latent)
    return latent

```
</code></pre></div></td></tr></table></div>
<p>The controlnet condition, usually the depthmap, blur, canny, is processed in the same way as the input image, and then prepared into a special kind condition with key <code>controlnet_cond</code>.</p>









  



<!-- 段落注释系统
<div class="comments-container annotation-container">
  <div class="comments-header">
    <h2 id="__annotations" class="comments-title">
      <span class="comments-icon">🔍</span>
      段落注释
      <span class="comments-subtitle">您可以高亮并评论任何文本!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <div class="hypothesis-instructions">
      <p><strong>如何使用段落注释功能：</strong></p>
      <ol>
        <li>点击右上角的 <img src="https://hypothes.is/assets/images/logo.png" alt="Hypothesis" style="height: 16px; vertical-align: middle;"> 图标打开侧边栏</li>
        <li>选择任意文本段落即可高亮并添加注释</li>
        <li>您还可以对其他人的注释进行回复</li>
      </ol>
    </div>
  </div>
</div> -->

<!-- 加载  -->
<script type="application/json" class="js-hypothesis-config">
{
  "openSidebar": false,
  "showHighlights": true,
  "theme": "clean"
}
</script>
<script async src="https://hypothes.is/embed.js"></script>

<!-- Hypothesis 样式美化 -->
<style>
  /* 修改高亮效果为下划线和聊天泡泡 */
  .hypothesis-highlight {
    background-color: transparent !important; /* 移除高亮背景 */
    text-decoration: underline !important;
    text-decoration-color: #4285f4 !important;
    text-decoration-thickness: 2px !important;
    text-decoration-style: wavy !important;
    position: relative !important;
    cursor: pointer !important;
    border-bottom: none !important; /* 移除之前的边框 */
    box-shadow: none !important; /* 移除之前的阴影 */
  }

  .hypothesis-highlight::after {
    content: "💬" !important;
    position: absolute !important;
    display: inline-block !important;
    font-size: 14px !important;
    top: -10px !important;
    right: -5px !important;
    opacity: 0.7 !important;
    transition: opacity 0.3s ease !important;
  }

  .hypothesis-highlight:hover {
    background-color: rgba(66, 133, 244, 0.08) !important; /* 鼠标悬停时的轻微背景 */
  }

  .hypothesis-highlight:hover::after {
    opacity: 1 !important;
    transform: scale(1.2) !important;
  }

  /* 美化 Hypothesis 侧边栏 */
  hypothesis-sidebar {
    font-family: var(--md-text-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif) !important;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1) !important;
  }

  /* 美化卡片样式 */
  .hypothesis-annotation-card {
    border-radius: 8px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05) !important;
    transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    overflow: hidden !important;
  }

  .hypothesis-annotation-card:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
  }

  /* 美化 Hypothesis 按钮 */
  .hypothesis-button {
    border-radius: 4px !important;
    transition: background-color 0.2s ease !important;
  }

  /* 美化标签样式 */
  .hypothesis-tag {
    border-radius: 12px !important;
    padding: 2px 8px !important;
    font-size: 12px !important;
    background-color: rgba(0, 0, 0, 0.05) !important;
    color: #606060 !important;
  }

  /* 美化工具栏 */
  .hypothesis-toolbar {
    background: linear-gradient(to right, #f5f5f5, #ffffff) !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
  }

  /* 美化注释面板header */
  .hypothesis-annotation-header {
    padding: 10px !important;
    background-color: #f9f9f9 !important;
  }

  /* 美化注释内容 */
  .hypothesis-annotation-body {
    font-size: 14px !important;
    line-height: 1.6 !important;
    color: #333 !important;
  }

  /* 美化用户名 */
  .hypothesis-user {
    font-weight: 600 !important;
    color: #3f51b5 !important;
  }

  /* 美化时间戳 */
  .hypothesis-timestamp {
    font-size: 12px !important;
    color: #757575 !important;
  }

  /* 美化输入框 */
  .hypothesis-input {
    border-radius: 4px !important;
    border: 1px solid #e0e0e0 !important;
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
  }

  .hypothesis-input:focus {
    border-color: #4dabf7 !important;
    box-shadow: 0 0 0 2px rgba(77, 171, 247, 0.2) !important;
    outline: none !important;
  }
</style>

<!-- 页面评论系统 -->
<div class="comments-container utterances-container">
  <div class="comments-header">
    <h2 id="__comments" class="comments-title">
      <span class="comments-icon">💬</span>
      Comments
      <span class="comments-subtitle">Share your thoughts!</span>
    </h2>
    <div class="comments-divider"></div>
  </div>

  <div class="comments-wrapper">
    <script src="https://utteranc.es/client.js"
            repo="MAD-SG/generative-ai-start-to-surrender"
            issue-term="pathname"
            label="comment"
            theme="preferred-color-scheme"
            crossorigin="anonymous"
            async>
    </script>
  </div>
</div>

<style>
  .comments-container {
    margin: 2.5rem auto;
    padding: 1.5rem;
    background: var(--md-code-bg-color, rgba(0, 0, 0, 0.05));
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .annotation-container {
    margin-bottom: 1rem;
    background: rgba(255, 255, 240, 0.5);
    border-left: 4px solid #ffeb3b;
  }

  .utterances-container {
    background: rgba(240, 248, 255, 0.5);
    border-left: 4px solid #2196f3;
  }

  .comments-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  }

  .comments-header {
    margin-bottom: 1.5rem;
  }

  .comments-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: var(--md-primary-fg-color, #2196f3);
    flex-wrap: wrap;
  }

  .annotation-container .comments-title {
    color: #f57c00;
  }

  .comments-icon {
    font-size: 1.4em;
  }

  .comments-subtitle {
    font-size: 0.7em;
    font-weight: 400;
    opacity: 0.8;
    margin-left: 1rem;
  }

  .comments-divider {
    height: 3px;
    background: linear-gradient(90deg,
      var(--md-primary-fg-color, #2196f3) 0%,
      rgba(255, 255, 255, 0) 100%);
    border-radius: 3px;
    margin-bottom: 1rem;
    width: 100%;
  }

  .annotation-container .comments-divider {
    background: linear-gradient(90deg,
      #f57c00 0%,
      rgba(255, 255, 255, 0) 100%);
  }

  .comments-wrapper {
    position: relative;
    min-height: 150px;
    width: 100%;
  }

  .hypothesis-instructions {
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
    margin-bottom: 1rem;
  }

  .hypothesis-instructions p {
    margin-top: 0;
    font-weight: 500;
  }

  .hypothesis-instructions ol {
    margin-bottom: 0;
    padding-left: 1.5rem;
  }

  .hypothesis-instructions li {
    margin-bottom: 0.5rem;
  }

  .hypothesis-instructions li:last-child {
    margin-bottom: 0;
  }

  /* 确保utterances的iframe填充可用宽度 */
  .utterances-container .comments-wrapper iframe {
    border-radius: 6px;
    width: 100% !important;
    max-width: 100% !important;
  }

  /* 动画效果 */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate3d(0, 20px, 0);
    }
    to {
      opacity: 1;
      transform: translate3d(0, 0, 0);
    }
  }

  .comments-wrapper {
    animation: fadeInUp 0.6s ease forwards;
  }

  /* 响应式设计 - 小屏幕调整 */
  @media (max-width: 768px) {
    .comments-container {
      padding: 1rem;
      margin: 1.5rem auto;
    }

    .comments-title {
      font-size: 1.3rem;
    }

    .comments-subtitle {
      display: block;
      width: 100%;
      margin-left: 0;
      margin-top: 0.3rem;
    }
  }
</style>
                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../stable_diffusion_3_reading/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Stable Diffusion 3">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Stable Diffusion 3
              </div>
            </div>
          </a>
        
        
          
          <a href="../flux1/" class="md-footer__link md-footer__link--next" aria-label="Next: Flux.1">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Flux.1
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://mad-sg.github.io/generative-ai-start-to-surrender/" target="_blank" rel="noopener" title="mad-sg.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/r/squidfunk/mkdocs-material/" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/mkdocs-material/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://bsky.app/profile/squidfunk.bsky.social" target="_blank" rel="noopener" title="bsky.app" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2 42.1-31.6 110.3-56 110.3 21.8 0 15.5-8.9 130.5-14.1 149.2-18.2 64.8-84.4 81.4-143.3 71.3C456 322 482.2 380 425.6 438c-107.4 110.2-154.3-27.6-166.3-62.9-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8c-12 35.3-59 173.1-166.3 62.9-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1 10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z"/></svg>
    </a>
  
    
    
      
    
    
    
      
      
    
    <a href="https://fosstodon.org/@squidfunk" target="_blank" rel="noopener me" title="fosstodon.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.5 102.5 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5m-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/squidfunk" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.tabs", "toc.integrate", "content.code.copy", "content.code.select", "content.code.annotate", "content.tabs.link", "content.footnote.tooltips", "content.tooltips", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.expand", "search.share", "search.suggest"], "search": "../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.26.1/minified.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>