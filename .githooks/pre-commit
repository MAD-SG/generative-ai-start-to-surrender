#!/bin/bash

# Find all modified markdown files in the commit
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$')

if [ -z "$FILES" ]; then
  echo "No markdown files to process."
  exit 0
fi

echo "Markdown files to process: $FILES"

# Process each markdown file
for file in $FILES; do
  if [ -f "$file" ]; then
    echo "Processing file: $file"

    # Ensure $$ block-level formulas are surrounded by blank lines
    awk '
      BEGIN { changed = 0 }
      {
        if ($0 ~ /^\$\$/) {
          if (prev != "") {
            print ""
            changed = 1
          }
          print $0
          getline next_line
          print $0
          if (next_line != "") {
            print ""
            changed = 1
          }
        }
        print
      }
      { prev = $0 }
      END {
        if (changed) {
          print "Updated $$ formatting in " FILENAME > "/dev/stderr"
        }
      }
    ' "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"

    # Re-add the updated file to the commit
    git add "$file"
  fi
done

exit 0
