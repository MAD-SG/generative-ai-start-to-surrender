#!/bin/bash

# Debugging: Output pre-commit trigger
echo "Pre-commit hook triggered."

# Find all modified markdown files in the commit
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$')

if [ -z "$FILES" ]; then
  echo "No markdown files to process."
  exit 0
fi

echo "Markdown files to process: $FILES"

# Process each markdown file
for file in $FILES; do
  if [ -f "$file" ]; then
    echo "Processing file: $file"

    # Add empty lines before and after $$ if missing
    awk '
      BEGIN { changed = 0 }
      /^\$\$/ {
        if (NR > 1 && prev != "") {
          print ""
          changed = 1
        }
      }
      { print }
      /^\$\$/ {
        getline next
        if (next != "") {
          print ""
          changed = 1
        }
        print next
      }
      { prev = $0 }
    ' "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"

    # Re-add the updated file to the commit
    git add "$file"
  fi
done

exit 0
